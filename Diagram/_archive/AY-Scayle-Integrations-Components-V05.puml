@startuml SCAYLE_AY_V05
allowmixing
title AY Marketplace Components Diagram
skinparam actorStyle awesome
together Quesitons{
    /'
    TODOS:
    4- From which file to which account?
    6- Marketplace/Merchant settlmentfiles are generated by SPA
    8- Assign unique names to files off hand.
    --------
    Non technical quesitons:
    11- Must there be another ledger in SCAYLE-Pay side?
    14- Is this system scalable, as the # of trans grows?
    15- Does this system offer real time processing? e.g. Immediate updates to acocunt balances and trans status
    16- Comprehensive transaction tracking & audit capabilities & trans history and details
    19- Are settlings and clearings between parties also possible?
    20- Is a robust error handling and failure recovery in place?
    22- Concurrency and Consistency: Does system handle concurrent transactions and maintain data consistency across distributed systems?
    23- Back up plan
    24- A robust disaster recovery plan
    25- High availability with minimal downtime
    --------
    26- (Modularity)How easy is it to replace or modify individual modules without affecting others?
    27- (Scalability)Are scaling mechanisms like load balancers and auto-scaling used effectively?
    28- (Scalability)How well does the system maintain performance under heavy loads?
    29- (Reliability)Are there mechanisms in place to handle and recover from failures gracefully?
    30- (Performance)Are there any performance bottlenecks in the system, and how are they addressed?
    31- (Availabiity)Are there any planned maintenance schedules that affect availability?
    32- (Extendibility)How easily can new features or functionalities be added to the system?
    33- (Extendibility)Are there well-defined extension points and APIs for integration?
    34- (Testability)How easy is it to test individual components in isolation?
    35- (Testability)Are there automated test suites covering critical functionalities?
    36- (Cost)How cost-effective is the architecture in terms of infrastructure and maintenance?
    37- (Cost)Are there any opportunities to optimize costs without sacrificing performance or reliability?
    '/
}
together Ideas{
    /'
    !$data= {"parts":
        [
            {"shape": "cloud",    "name": "id1", "colour": "#palegreen", "desc": "some text"},
            {"shape": "folder",   "name": "id2", "colour": "#lightblue", "desc": "more text"},
            {"shape": "database", "name": "id3", "colour": "#pink",      "desc": "even more text"}
        ]
    }
    rectangle Outer {
        rectangle Inner #tan as "
            {
                {
                    json $data
                }
            }"
    }
    '/
}
together PreProcesses{
    !$nowDT = %date("yyyy.MM.dd' at 'HH:mm")
    !$SALE = {"Total": 1000}
    !$PSP = {"FeeRate": 1, "FeeValue": 10, "TaxRate": 20, "TaxValue": 2}
    !$SCAYLE = {"FeeRate": 2, "FeeValue": 20, "TaxCode": "VAT", "TaxRate": 20, "TaxValue": 4}
    !$MP = {"CommissionRate": 7, "CommissionValue": 70, "TaxCode": "VAT", "TaxRate": 20, "TaxValue": 14}
    !$MERCHANT = {"SaleCutRate": 90, "SaleValue": 900}

    !function $SC_Assets()
        !$a = %intval($SALE.Total)
        !return $a
    !endfunction

    !function $SC_Liabilities()
        !$a = %intval($PSP.FeeValue)
        !$b = %intval($MP.CommissionValue)
        !$c = %intval($SCAYLE.TaxValue)
        !$d = %intval($MERCHANT.SaleValue)
        !return $a + $b + $c + $d
    !endfunction

    !function $SC_Equities()
        !return $SC_Assets()-$SC_Liabilities()
    !endfunction

    !function $PSP_Payout()
        !$a = %intval($SALE.Total)
        !$b = %intval($PSP.FeeValue)
        !return $a-$b
    !endfunction

}
together Definiations{
    actor AlexTheCustomer
    package "AY MP Store UI" #AA6DFF{
        package "Basket<&basket>" {
            package "Merchants" {
                package "AdidasTheMerchant" {
                    object RunningShoes{
                        <img:https://assets.adidas.com/images/h_840,f_auto,q_auto,fl_lossy,c_fill,g_auto/2a933a19fc8b468a9c82af9c00ed602b_9366/Adistar_2.0_Running_Shoes_Red_HP5644_011_hover_standard.jpg{scale=0.2}>
                        =Price: 1000 euro
                        |_ 19% vat included
                    }
                }
            }
            component [Checkout]
        }
    }
    node "PSPs" #FF4081{
        package Klarna #PaleVioletRed{
            package Klarna_Authorize_Issues{
                file {
                    json MarketPlace_SettlmentLine1<<Authorization>> {
                        "operation_key": "82eafcb9",
                        "operation_timestamp": "2022-12-08 17:17:40",
                        "operation_type": "authorization",
                        "operation_value": $SALE.Total,
                        "transaction_key": "9ce15ecf",
                        "authorized_value": $SALE.Total,
                        "authorized_timestamp": "2022-12-08 17:17:40",
                        "marketplace_transaction_reference": "ALPHA-SE-002",
                        "currency_code": "SEK",
                        "payment_method_code": "instant_capture",
                        "item_key": "04f4c1f2",
                        "marketplace_item_reference": "item#279986",
                        "item_description": "RunningShoes",
                        "merchant_key": "5da36e89",
                        "merchant_name": "Adidas",
                        "merchant_country_of_origin": "DEU",
                        "shop_key": "3b3698d3",
                        "shop_name": "Alpha SE",
                        "consumer_invoice_reference": "NULL",
                        "consumer_invoice_timestamp": "",
                        "commission_code": "NULL",
                        "initial_value": $SALE.Total,
                        "commission_rate": $MP.CommissionRate,
                        "commission_value": $MP.CommissionValue,
                        "commission_vat_rate": $MP.TaxRate,
                        "commission_vat_value": $MP.TaxValue,
                        "payment_fee_rate": $PSP.FeeRate,
                        "payment_fee_value": $PSP.FeeValue,
                        "payment_fee_vat_rate": $PSP.TaxRate,
                        "payment_fee_vat_value": $PSP.TaxValue,
                        "reversal_penalty": "0,00",
                        "reversal_reason": "NULL",
                        "payout_currency_code": "EUR",
                        "exchange_rate": "",
                        "custom_data": "",
                        "payout_value": $PSP_Payout()
                    }
                }
            }
            package Klarna_Capture_Issuer{
                file {
                    json PSP_SettlmentTrans1<<FEE>> {
                        "type": "FEE",
                        "capture_date": "2022-12-11T23:06:22.000Z",
                        "sale_date": "2022-12-05T16:50:23.168Z",
                        "order_id": "8b2dea16-2ba3-456d-8203-f1f655a4e612",
                        "short_order_id": "0NK4H6L6-1",
                        "capture_id": "80157a40-5a26-467f-934e-b90c26549071",
                        "merchant_reference1": "ayou-139-204559361",
                        "merchant_reference2": "",
                        "amount": $PSP.FeeValue,
                        "posting_currency": "EUR",
                        "refund_id": "",
                        "purchase_country": "DE"
                    }
                    json PSP_SettlmentTrans2<<Sale>>{
                        "type": "SALE",
                        "capture_date": "2022-12-11T23:06:22.000Z",
                        "sale_date": "2022-12-05T16:50:23.168Z",
                        "order_id": "8b2dea16-2ba3-456d-8203-f1f655a4e612",
                        "short_order_id": "0NK4H6L6-1",
                        "capture_id": "80157a40-5a26-467f-934e-b90c26549071",
                        "merchant_reference1": "ayou-139-204559361",
                        "merchant_reference2": "",
                        "amount": $PSP_Payout(),
                        "posting_currency": "EUR",
                        "refund_id": "",
                        "purchase_country": "DE"
                    }
                }
            }
            package Klarna_Void_Issuer
            package Klarna_Return_Issuer
        }
    }
    package "SCAYLE Pay" #SpringGreen{
        object Refrences{
            =Fees, Taxes, Commissions
            |= |=  Klarna fee  |=  Scayle fee  |=  MP commission |=  ScaylePay VAT  |= AY MP VAT |= PSP VAT |= Merchants VAT |
            <#lightgreen>| Refrence | $PSP.FeeRate  | $SCAYLE.FeeRate | $MP.CommissionRate | $SCAYLE.TaxRate | We don't care | We don't care | We don't care |
            | Sample: $SALE.Total € | $PSP.FeeValue €  | $SCAYLE.FeeValue € | $MP.CommissionValue € | $SCAYLE.TaxValue € | We don't care | We don't care | We don't care |

            =ExchangeRates
            |= # |= Unit |= CurrencySource |= CurrencyDestination |= Rate |= Date |
            | 1 | 1 | EUR | USD | 1.08 | $nowDT | 
            | 2 | 1 | GBP | EUR | 1.16 | $nowDT | 
            | 3 | 1 | EUR | JPY | 157.02 | $nowDT | 
        }
        component PaymentCoordinator #FF4081
        () "MonthlyBatchJob"
        component PayoutDistributor
        together PayoutSettlments{
            component MarketPlacePayoutIssuer {
                file {
                    json MarketPlace_SettlmentLine2<<Capture>> {
                        "operation_key": "493c887f",
                        "operation_timestamp": "2022-12-09 18:15:16",
                        "operation_type": "capture",
                        "operation_value": $MP.CommissionValue,
                        "transaction_key": "9ce15ecf",
                        "authorized_value": $MP.CommissionValue,
                        "authorized_timestamp": "2022-12-08 17:17:40",
                        "marketplace_transaction_reference": "ALPHA-SE-002",
                        "currency_code": "EUR",
                        "payment_method_code": "instant_capture",
                        "item_key": "04f4c1f2",
                        "marketplace_item_reference": "item#279986",
                        "item_description": "RunningShoes",
                        '-----------------------------
                        'These fields are extra
                        "merchant_key": "5da36e89",
                        "merchant_name": "Adidas",
                        "merchant_country_of_origin": "DEU",
                        '-----------------------------
                        "shop_key": "3b3698d3",
                        "shop_name": "Alpha SE",
                        '-----------------------------
                        'Invoice number differs
                        "consumer_invoice_reference": "invoice-2023#0051",
                        '-----------------------------
                        "consumer_invoice_timestamp": "2022-12-09 18:00:52",
                        "commission_code": "shirts_children",
                        "<color:#red>initial_value": $SALE.Total,
                        "commission_rate": $MP.CommissionRate,
                        "commission_value": $MP.CommissionValue,
                        "commission_vat_rate": $MP.TaxRate,
                        "commission_vat_value": $MP.TaxValue,
                        '------------------------------
                        'These fields are extra
                        "<color:#red>payment_fee_rate": $SCAYLE.FeeRate,
                        "payment_fee_value": $SCAYLE.FeeValue,
                        "payment_fee_vat_rate": $SCAYLE.TaxRate,
                        "payment_fee_vat_value": $SCAYLE.TaxValue,
                        '------------------------------
                        "reversal_penalty": "0,00",
                        "reversal_reason": "NULL",
                        "payout_currency_code": "EUR",
                        "exchange_rate": "1",
                        "custom_data": "",
                        "payout_value": $MP.CommissionValue
                    }
                }
            }
            component MerchantPayoutIssuer{
                file {
                    json MerchantTrans1<<Capture>> {
                        "operation_key" : "338c8bd8",
                        "operation_timestamp": "2022-12-09 21:36:52",
                        "operation_type": "capture",
                        "operation_amount": $MERCHANT.SaleValue,
                        "transaction_key": "9ce15ecf",
                        "authorized_amount": $MERCHANT.SaleValue,
                        "authorized_timestamp": " 2022-12-08 17:17:40",
                        "marketplace_transaction_reference": "ALPHA-SE-002",
                        "currency_code": "EUR",
                        "payment_method_code": "instant_capture",
                        "item_key": "5c46693c",
                        "marketplace_item_reference": "item#39998",
                        "item_description": "RunningShoes",
                        "shop_key": "3b3698d3",
                        "shop_name": "Alpha SE",
                        "consumer_invoice_reference": "invoice-2023#0005",
                        "consumer_invoice_timestamp": " 2022-12-09 21:22:28",
                        "commission_code": "shirts_children",
                        "initial_amount": $SALE.Total,
                        "commission_rate": $MP.CommissionRate,
                        "commission_amount": $MP.CommissionValue,
                        "commission_vat_rate": $MP.TaxRate,
                        "commission_vat_amount": $MP.TaxValue,
                        "reversal_penalty": 0,
                        "reversal_reason": "NULL",
                        "payout_currency_code": "EUR",
                        "exchange_rate": 1,
                        "custom_data": "forceclose=true",
                        "payout_value": $MERCHANT.SaleValue
                    }
                }
            }
        }
        component TransCollectorAPI #Peru{
            node PSP_Settlments{
                file PSP_Fee_Settlment
                file PSP_Sale_Settlment
            }
            node SCAYLE_Pay_Settlments{
                file MarketPlace_Payout_Settlment
                file Merchant_Payout_Settlment
            }
        }
        component EscrowBalanceManagerAPI #DarkTurquoise
        component ScayleAuditingControlCenter #MediumPurple
    }
    package "ServiceMiddlewareLayer" #5094FC{
        package "MonitoringAndAuditing"<<Write-only>> #Darkorange{
            node AuditingAPI #BlueViolet
            node UniversalStatusTracker #DarkGray{
                portin add_status
                portout inquiryTransTracks
                
                together OperationLogs{
                    database UniversalStatusDB<<NoSQL>> as"
                    =Klarna_Authorization
                    |= internal_operation_unique_id |= file_name |= Operation_key |= transaction_key |= operation_timestamp |= operation_type |= Phase |= status |= JournalNum |= Voucher |= description |= datetime |
                    | ayspop-abcde-000000000001 | settlements_DE_Klarna_221112_221212.csv | 82eafcb9 | 9ce15ecf | 2023-07-26T18:11:14:09UTC | authorization | Validation | <color:green>Succeeded |  |  |  | 2023-07-26T18:11:10:09UTC |
                    | ayspop-abcde-000000000002 | settlements_DE_Klarna_221112_221212.csv | 82eafcb9 | 9ce15ecf | 2023-07-26T18:11:14:09UTC | authorization | Uplaoding | <color:green>Succeeded |  |  |  | 2023-07-26T18:11:10:09UTC |
                    | ayspop-abcde-000000000003 | settlements_DE_Klarna_221112_221212.csv | 82eafcb9 | 9ce15ecf | 2023-07-26T18:11:14:09UTC | authorization | Transformation | <color:green>Succeeded |  |  |  | 2023-07-26T18:11:10:09UTC |
                    | ayspop-abcde-000000000004 | settlements_DE_Klarna_221112_221212.csv | 82eafcb9 | 9ce15ecf | 2023-07-26T18:11:14:09UTC | authorization | Reconiliation | <color:green>Succeeded |  |  | [ReferenceFileName: SCAYLE_Pay_2022_12_11.csv] | 2023-07-26T18:11:10:09UTC |
                    | ayspop-abcde-000000000005 | settlements_DE_Klarna_221112_221212.csv | 82eafcb9 | 9ce15ecf | 2023-07-26T18:11:14:09UTC | authorization | Aggregation | <color:green>Succeeded |  |  | [AggregationId: 0000000000009182] | 2023-07-26T18:11:10:09UTC |
                    | ayspop-abcde-000000000006 | settlements_DE_Klarna_221112_221212.csv | 82eafcb9 | 9ce15ecf | 2023-07-26T18:11:14:09UTC | authorization | ResultGeneration | <color:green>Succeeded |  |  |  | 2023-07-26T18:11:10:09UTC |
                    | ayspop-abcde-000000000007 | settlements_DE_Klarna_221112_221212.csv | 82eafcb9 | 9ce15ecf | 2023-07-26T18:11:14:09UTC | authorization | ResultPersistance | <color:green>Succeeded |  |  |  | 2023-07-26T18:11:10:09UTC |
                    | ayspop-abcde-000000000008 | settlements_DE_Klarna_221112_221212.csv | 82eafcb9 | 9ce15ecf | 2023-07-26T18:11:14:09UTC | authorization | SendingOut | <color:green>Succeeded |  |  | [OutputFileName: ayspop-abcde-000000000008.zip] | 2023-07-26T18:11:10:09UTC |
                    | ayspop-abcde-000000000009 | settlements_DE_Klarna_221112_221212.csv | 82eafcb9 | 9ce15ecf | 2023-07-26T18:11:14:09UTC | authorization | Ledgered | <color:green>Succeeded | GLJour-0000000015 | SCAP-Jour-0000000000598927 | [LegalEntity: SCAP, JournalNum: GLJour-0000000015, Voucher: SCAP-Jour-0000000000598927] | 2023-07-26T18:11:10:09UTC |

                    =Klarna_SALE
                    |= internal_operation_unique_id |= file_name |= order_id |= Operation_type |= capture_date |= Phase |= status |= JournalNum |= Voucher |= description |= datetime |
                    | ayspop-abcde-000000000010 | settlements_DE_klarna_221112_221212.csv | 8b2dea16-2ba3-456d-8203-f1f655a4e612 | SALE | 2022-12-11T23:06:22.000Z | Validation | <color:green>Succeeded |  |  |  | 2023-07-26T18:11:10:09UTC |
                    | ayspop-abcde-000000000011 | settlements_DE_klarna_221112_221212.csv | 8b2dea16-2ba3-456d-8203-f1f655a4e612 | SALE | 2022-12-11T23:06:22.000Z | Uplaoding| <color:green>Succeeded |  |  |  | 2023-07-26T18:11:11:09UTC |
                    | ayspop-abcde-000000000012 | settlements_DE_klarna_221112_221212.csv | 8b2dea16-2ba3-456d-8203-f1f655a4e612 | SALE | 2022-12-11T23:06:22.000Z | Transformation| <color:green>Succeeded |  |  |  | 2023-07-26T18:11:12:09UTC |
                    | ayspop-abcde-000000000013 | settlements_DE_klarna_221112_221212.csv | 8b2dea16-2ba3-456d-8203-f1f655a4e612 | SALE | 2022-12-11T23:06:22.000Z | Reconiliation| <color:green>Succeeded |  |  | [ReferenceFileName: SCAYLE_Pay_2022_12_11.csv] | 2023-07-26T18:11:13:09UTC |
                    | ayspop-abcde-000000000014 | settlements_DE_klarna_221112_221212.csv | 8b2dea16-2ba3-456d-8203-f1f655a4e612 | SALE | 2022-12-11T23:06:22.000Z | Aggregation| <color:green>Succeeded |  |  | [AggregationId: 0000000000009183] | 2023-07-26T18:11:14:09UTC |
                    | ayspop-abcde-000000000015 | ettlements_DE_klarna_221112_221212.csv | 8b2dea16-2ba3-456d-8203-f1f655a4e612 | SALE | 2022-12-11T23:06:22.000Z | ResultGeneration| <color:green>Succeeded |  |  |  | 2023-07-26T18:15:10:09UTC |
                    | ayspop-abcde-000000000016 | settlements_DE_klarna_221112_221212.csv | 8b2dea16-2ba3-456d-8203-f1f655a4e612 | SALE | 2022-12-11T23:06:22.000Z | ResultPersistance| <color:green>Succeeded |  |  |  | 2023-07-26T18:11:16:09UTC |
                    | ayspop-abcde-000000000017 | settlements_DE_klarna_221112_221212.csv | 8b2dea16-2ba3-456d-8203-f1f655a4e612 | SALE | 2022-12-11T23:06:22.000Z | SendingOut| <color:red>Failed |  |  | [Destination: SCAYLEPayERP, ResponseCode: 429, ErrorMessage: "Too many requests"] | 2023-07-26T18:11:17:09UTC |
                    | ayspop-abcde-000000000018 | settlements_DE_klarna_221112_221212.csv | 8b2dea16-2ba3-456d-8203-f1f655a4e612 | SALE | 2022-12-11T23:06:22.000Z | SendingOut| <color:green>Succeeded |  |  | [[ReferenceOperation: ayspop-abcde-000000000017],[OutputFileName: ayspop-abcde-000000000018.zip]] | 2023-07-26T18:11:18:09UTC |
                    | ayspop-abcde-000000000019 | settlements_DE_klarna_221112_221212.csv | 8b2dea16-2ba3-456d-8203-f1f655a4e612 | SALE | 2022-12-11T23:06:22.000Z | Ledgered | <color:green>Succeeded | GLJour-0000000016 | SCAP-Jour-0000000000598928 | [LegalEntity: SCAP, JournalNum: GLJour-0000000016, Voucher: SCAP-Jour-0000000000598928] | 2023-07-27T18:11:17:09UTC |

                    =Klarna_Fee
                    |= internal_operation_unique_id |= file_name |= order_id |= Operation_type |= capture_date |= Phase |= status |= JournalNum |= Voucher |= description |= datetime |
                    | ayspop-abcde-000000000020 | settlements_DE_klarna_221112_221212.csv | 8b2dea16-2ba3-456d-8203-f1f655a4e612 | FEE | 2022-12-11T23:06:22.000Z | Validation | <color:green>Succeeded |  |  |  | 2023-07-26T18:11:10:09UTC |
                    | ayspop-abcde-000000000021 | settlements_DE_klarna_221112_221212.csv | 8b2dea16-2ba3-456d-8203-f1f655a4e612 | FEE | 2022-12-11T23:06:22.000Z | Uplaoding| <color:green>Succeeded |  |  |  | 2023-07-26T18:11:11:09UTC |
                    | ayspop-abcde-000000000022 | settlements_DE_klarna_221112_221212.csv | 8b2dea16-2ba3-456d-8203-f1f655a4e612 | FEE | 2022-12-11T23:06:22.000Z | Transformation| <color:green>Succeeded |  |  |  | 2023-07-26T18:11:12:09UTC |
                    | ayspop-abcde-000000000023 | settlements_DE_klarna_221112_221212.csv | 8b2dea16-2ba3-456d-8203-f1f655a4e612 | FEE | 2022-12-11T23:06:22.000Z | Reconiliation| <color:green>Succeeded |  |  | [ReferenceFileName: SCAYLE_Pay_2022_12_11.csv] | 2023-07-26T18:11:13:09UTC |
                    | ayspop-abcde-000000000024 | settlements_DE_klarna_221112_221212.csv | 8b2dea16-2ba3-456d-8203-f1f655a4e612 | FEE | 2022-12-11T23:06:22.000Z | Aggregation| <color:green>Succeeded |  |  | [AggregationId: 0000000000009184] | 2023-07-26T18:11:14:09UTC |
                    | ayspop-abcde-000000000025 | settlements_DE_klarna_221112_221212.csv | 8b2dea16-2ba3-456d-8203-f1f655a4e612 | FEE | 2022-12-11T23:06:22.000Z | ResultGeneration| <color:green>Succeeded |  |  |  | 2023-07-26T18:15:10:09UTC |
                    | ayspop-abcde-000000000026 | settlements_DE_klarna_221112_221212.csv | 8b2dea16-2ba3-456d-8203-f1f655a4e612 | FEE | 2022-12-11T23:06:22.000Z | ResultPersistance| <color:green>Succeeded |  |  |  | 2023-07-26T18:11:16:09UTC |
                    | ayspop-abcde-000000000027 | settlements_DE_klarna_221112_221212.csv | 8b2dea16-2ba3-456d-8203-f1f655a4e612 | FEE | 2022-12-11T23:06:22.000Z | SendingOut| <color:red>Failed |  |  | [Destination: SCAYLEPayERP, ResponseCode: 429, ErrorMessage: "Too many requests"] | 2023-07-26T18:11:17:09UTC |
                    | ayspop-abcde-000000000028 | settlements_DE_klarna_221112_221212.csv | 8b2dea16-2ba3-456d-8203-f1f655a4e612 | FEE | 2022-12-11T23:06:22.000Z | SendingOut| <color:green>Succeeded |  |  | [[ReferenceOperation: ayspop-abcde-000000000027],[OutputFileName: ayspop-abcde-000000000028.zip]] | 2023-07-26T18:11:18:09UTC |
                    | ayspop-abcde-000000000029 | settlements_DE_klarna_221112_221212.csv | 8b2dea16-2ba3-456d-8203-f1f655a4e612 | FEE | 2022-12-11T23:06:22.000Z | Ledgered | <color:green>Succeeded | GLJour-0000000017 | SCAP-Jour-0000000000598929 | [LegalEntity: SCAP, JournalNum: GLJour-0000000017, Voucher: SCAP-Jour-0000000000598929] | 2023-07-27T18:11:17:09UTC |

                    =MarketPlacePayout
                    |= internal_operation_unique_id |= file_name |= Operation_key |= transaction_key |= operation_timestamp |= operation_type |= Phase |= status |= JournalNum |= Voucher |= description |= datetime |
                    | ayspop-abcde-000000000030 | SCAYLE_PAY_Marketplace_Settlement_2022_12_12.csv | 493c887f | 9ce15ecf | 2022-12-09 18:15:16 | capture | Validation | <color:green>Succeeded |  |  |  | 2023-07-26T18:11:10:09UTC |
                    | ayspop-abcde-000000000031 | SCAYLE_PAY_Marketplace_Settlement_2022_12_12.csv | 493c887f | 9ce15ecf | 2023-07-26T18:11:14:09UTC | capture | Uplaoding | <color:green>Succeeded |  |  |  | 2023-07-26T18:11:10:09UTC |
                    | ayspop-abcde-000000000032 | SCAYLE_PAY_Marketplace_Settlement_2022_12_12.csv | 493c887f | 9ce15ecf | 2023-07-26T18:11:14:09UTC | capture | Transformation | <color:green>Succeeded |  |  |  | 2023-07-26T18:11:10:09UTC |
                    | ayspop-abcde-000000000033 | SCAYLE_PAY_Marketplace_Settlement_2022_12_12.csv | 493c887f | 9ce15ecf | 2023-07-26T18:11:14:09UTC | capture | Reconiliation | <color:green>Succeeded |  |  | [ReferenceFileName: SCAYLE_Pay_2022_12_11.csv] | 2023-07-26T18:11:10:09UTC |
                    | ayspop-abcde-000000000034 | SCAYLE_PAY_Marketplace_Settlement_2022_12_12.csv | 493c887f | 9ce15ecf | 2023-07-26T18:11:14:09UTC | capture | Aggregation | <color:green>Succeeded |  |  | [AggregationId: 0000000000009185] | 2023-07-26T18:11:10:09UTC |
                    | ayspop-abcde-000000000035 | SCAYLE_PAY_Marketplace_Settlement_2022_12_12.csv | 493c887f | 9ce15ecf | 2023-07-26T18:11:14:09UTC | capture | ResultGeneration | <color:green>Succeeded |  |  |  | 2023-07-26T18:11:10:09UTC |
                    | ayspop-abcde-000000000036 | SCAYLE_PAY_Marketplace_Settlement_2022_12_12.csv | 493c887f | 9ce15ecf | 2023-07-26T18:11:14:09UTC | capture | ResultPersistance | <color:green>Succeeded |  |  |  | 2023-07-26T18:11:10:09UTC |
                    | ayspop-abcde-000000000037 | SCAYLE_PAY_Marketplace_Settlement_2022_12_12.csv | 493c887f | 9ce15ecf | 2023-07-26T18:11:14:09UTC | capture | SendingOut | <color:green>Succeeded |  |  | [OutputFileName: ayspop-abcde-000000000008.zip] | 2023-07-26T18:11:10:09UTC |
                    | ayspop-abcde-000000000038 | SCAYLE_PAY_Marketplace_Settlement_2022_12_12.csv | 493c887f | 9ce15ecf | 2023-07-26T18:11:14:09UTC | capture | Ledgered | <color:green>Succeeded | GLJour-0000000018 | SCAP-Jour-0000000000598930 | [LegalEntity: SCAP, JournalNum: GLJour-0000000018, Voucher: SCAP-Jour-0000000000598930] | 2023-07-26T18:11:10:09UTC |

                    =MerchantPayout
                    |= internal_operation_unique_id |= file_name |= Operation_key |= transaction_key |= operation_timestamp |= operation_type |= Phase |= status |= JournalNum |= Voucher |= description |= datetime |
                    | ayspop-abcde-000000000039 | SCAYLE_PAY_Merchant_Settlement_2022_12_12.csv | 338c8bd8 | 9ce15ecf | 2022-12-09 21:36:52 | capture | Validation | <color:green>Succeeded |  |  |  | 2023-07-26T18:11:10:09UTC |
                    | ayspop-abcde-000000000040 | SCAYLE_PAY_Merchant_Settlement_2022_12_12.csv | 338c8bd8 | 9ce15ecf | 2022-12-09 21:36:52 | capture | Uplaoding | <color:green>Succeeded |  |  |  | 2023-07-26T18:11:10:09UTC |
                    | ayspop-abcde-000000000041 | SCAYLE_PAY_Merchant_Settlement_2022_12_12.csv | 338c8bd8 | 9ce15ecf | 2022-12-09 21:36:52 | capture | Transformation | <color:green>Succeeded |  |  |  | 2023-07-26T18:11:10:09UTC |
                    | ayspop-abcde-000000000042 | SCAYLE_PAY_Merchant_Settlement_2022_12_12.csv | 338c8bd8 | 9ce15ecf | 2022-12-09 21:36:52 | capture | Reconiliation | <color:green>Succeeded |  |  | [ReferenceFileName: SCAYLE_Pay_2022_12_11.csv] | 2023-07-26T18:11:10:09UTC |
                    | ayspop-abcde-000000000043 | SCAYLE_PAY_Merchant_Settlement_2022_12_12.csv | 338c8bd8 | 9ce15ecf | 2022-12-09 21:36:52 | capture | Aggregation | <color:green>Succeeded |  |  | [AggregationId: 0000000000009186] | 2023-07-26T18:11:10:09UTC |
                    | ayspop-abcde-000000000044 | SCAYLE_PAY_Merchant_Settlement_2022_12_12.csv | 338c8bd8 | 9ce15ecf | 2022-12-09 21:36:52 | capture | ResultGeneration | <color:green>Succeeded |  |  |  | 2023-07-26T18:11:10:09UTC |
                    | ayspop-abcde-000000000045 | SCAYLE_PAY_Merchant_Settlement_2022_12_12.csv | 338c8bd8 | 9ce15ecf | 2022-12-09 21:36:52 | capture | ResultPersistance | <color:green>Succeeded |  |  |  | 2023-07-26T18:11:10:09UTC |
                    | ayspop-abcde-000000000046 | SCAYLE_PAY_Merchant_Settlement_2022_12_12.csv | 338c8bd8 | 9ce15ecf | 2022-12-09 21:36:52 | capture | SendingOut | <color:green>Succeeded |  |  | [OutputFileName: ayspop-abcde-000000000008.zip] | 2023-07-26T18:11:10:09UTC |
                    | ayspop-abcde-000000000047 | SCAYLE_PAY_Merchant_Settlement_2022_12_12.csv | 338c8bd8 | 9ce15ecf | 2022-12-09 21:36:52 | capture | Ledgered | <color:green>Succeeded | GLJour-0000000019 | SCAP-Jour-0000000000598931 | [LegalEntity: SCAP, JournalNum: GLJour-0000000019, Voucher: SCAP-Jour-0000000000598931] | 2023-07-26T18:11:10:09UTC |

                    "
                }
                
            }
            
        }
        component EntryPoint #DarkOrchid{
            database EntryPoint_Logs
            component RateLimiter
        }
        queue FlowOrchestrator #Tomato {
            legend 
            = Guarantees
            ----
            *Exactly-once delivery
            |_ Retry
            |_ Idempotency check
            end legend

            portin Validate
            portin Upload
            portin Download
            portin Transform
            portin Reconcile
            portin Aggregate
            portin Generate
            portin Save

            portout Validated
            portout Uploaded
            portout Downloaded
            portout Transformed
            portout Reconciled
            portout Aggregated
            portout Generated
            portout Saved 
            portout Logger

            object RoutingLogic{
                |= RoutineID |= Source |= Direction |= Destination Node |= Next Station |= Type of op. |= Status |= Logging Individually|
                | 1 | Validate | => | ValidatorAPI | 2 | Async | Enabled | Yes |
                | 2 | Validated | => | Upload | 3 | Async | Enabled | Yes |
                | 3 | Upload | => | UploaderAPI | 4 | Async | Enabled | Yes |
                | 4 | Uploaded | => | Download | 5 | Async | Enabled | Yes |
                | 5 | Download | => | MasterDataDownloaderAPI | 6 | Async | Enabled | Yes |
                | 6 | Downloaded | => | Transform | 7 | Async | Enabled | Yes |
                | 7 | Transform | => | TransformerAPI | 8 | Async | Enabled | Yes |
                <#LightCoral>| 8 | Transformed | => | Reconcile | 9 | Async | Enabled | Yes |
                <#LightCoral>| 9 | Reconcile | => | ReconcilerAPI | 10 | Async | Enabled | Yes |
                <#LightCoral>| 10 | Reconciled | => | Aggregate | 11 | Async | Enabled | Yes |
                | 11 | Aggregate | => | AggregatorAPI | 12 | Async | Enabled | Yes |
                | 12 | Aggregated | => | Generate | 13 | Async | Enabled | Yes |
                | 13 | Generate | => | ResultGeneratorAPI | 14 | Async | Enabled | Yes |
                | 14 | Generated | => | Save | 15 | Async | Enabled | Yes |
                | 15 | Save | => | ResultSaverAPI | 16 | Async | Enabled | Yes |
                | 16 | Saved | => | Logger | 0 | Async | Enabled | Yes |
            }
        }
        package APIGateway #LightYellow{
            database APIGateway_Logs
            component Validator #LightCyan{
                component ValidatorAPI
                database Validator_Logs
            }
            component Uploader #Peru {
                component UploaderAPI
                database Uploader_Logs
            }
            component MasterDataDownloader #LightSeaGreen{ 
                component MasterDataDownloaderAPI
                database MasterDataDownloader_Logs 
            }
            component Reconciler #00C853 {
                database Reconciler_Logs
                component [ReconcilerAPI]
                package "MatchFinderLogic" {
                    component [MatchFinderAPI]
                    object MatchFindingRules {
                        * File name --> FileNamePatternMap
                        * Date
                        * Filestamp
                        * Operation key
                        ---
                        * JournalNum(?)
                        ---
                    }
                    component FileNamesPattern {
                        object FileNamePatternMap{
                            = Klarna
                            |=  |= PSP |= Merchant |= MarketPlace |
                            | **Pattern** | ["settlments"]_[CountryCode]_["Klarna"]_[Date]_[Date].csv | ["SCAYLE PAY"]_["Marketplace"]_["Settlement"]_[Date].csv | ["SCAYLE PAY"]_["Merchant"]_["Settlement"]_[Date].csv |
                            | **Common filters** | [Date] | [Date] | [Date] |
                            | **Other applicable filters** | [CountryCode], [PSPName] | "SCAYLE PAY", "Marketplace" | "Merchant" |
                        }
                    }
                }
            }
            component Aggregator #FF6F00 {
                database Aggregator_Logs
                component [AggregatorAPI]
                component [AggregatingRules] {
                    object Grouping {
                        * MerchantCode
                        * Date
                    }
                }
            }
            component Transformer #FFD600{
                database Transformer_Logs
                component [TransformerAPI]
                component [TransformingRules]
                component [TransformingMaps] {
                    map intial {
                        XML => CSV
                        CVS => JSON
                        AmountStr => Integer
                        DateFormat => YY MM DD HH MM SS
                        "operartion_value" => "OpValue"
                        "operation_amount" => "OpValue"
                    }
                    map final {
                        OpValue => NetAmount
                        FinancialDimensionConvension => Channel-Merchant-ShopKey
                    }
                }
            }
            component ResultGenerator #OliveDrab{
                database ResultGenerator_Logs
                component [ResultGeneratorAPI]
                component [ChoosingResultTemplateRules]
                object ResultTemplates {
                    * GL_Jour
                    * Corrective_Jour
                    * Customer_Invoice
                    * FreeText_Invoice
                    * CreditNote
                }
            }
            component ResultSaver #LightCoral{
                component ResultSaverAPI
                database ResultSaver_Logs
            }
        }
    }
    package "<color:white>Persistance" #DarkMagenta {
        legend 
        =Transactions files containers
        ----
        CustomerBA_SetlmentFiles
        ----
        AYCommission_SettlmentFiles
        ----
        MerchantBA_SettlmentFiles
        ----
        ScayleEscrowBA_SettlmentFiles
        ----
        ScayleFeeBA_SettlmentFiles
        ----
        ScayleTrans_Files
        end legend
        database Database #Salmon as"
                    Transformed data
                    ===
                    Reconciled data
                    ===
                    Aggregated data
                    ===
                    Master data
                    == Refrence data ==
                    Cached data
                    ===
                    WaitedForMatching data
                    ===
                    Configuration data
                    ===
                    Paramaters data
    "
        package "DataIntegrationBlob" #MediumSpringGreen {
            component [D365FinOpsERP_Outbound_Storage]
        }
    }
    Package Banks #DarkTurquoise{
        node SettlmentFilesCollectorAPI #Khaki{
            portin settlment_file_portin
            portout settlment_file_portout
        }
        node "UserBank" {
            component [CustomerBA]
        }
        node "ScayleBank" {
            package "ScayleBA.s" {
                component [EscrowBA]
                component [ScayleFeeCollectorBA]
            }
        }
        node "MarketPlacesBanks" {
            package "Marketplaces BA.s" {
                package "AYMPC" {
                    component [AYCommissionCollectorBA]
                }
            }
        }
        node "MerchantBank" {
            node "Merchants BA.s" {
                component [AdidasSalesCollectorBA]
            }
        }
        node "KlarnaBank" {
            node "Klarna BA.s" {
                component [KlarnaFeeCollectorBA]
            }
        }
    }
    together ERPGang{
        package "D365 Finance ERP System" #MediumSlateBlue{
            package "AYHL Legal Entity" {
                package SharedData {
                    Package Parties{
                        object Adidas {
                            |= Property |= Value |
                            | MainAccount | 11101110111 |
                            | OffsetAccount | 99909990999 |
                            | Address | Deutschland |
                            | Currency | Euro |
                            | FinancialDimensions | ["ShopKey", "Location", "Channel"] |
                            | Roles | "["Customer", "Vendor"]" |
                        }
                    }
                }
                package "SPAY Legal Entity" as SPAYLE #SpringGreen {
                    package "Data management framework" {
                        node JournalsDataEntity
                    }
                    package GL {
                        object Rules{
                            * =Assets = Liabilities + Equity
                            * Assets and Expenses: +Dr and -Cr
                            * Liabilities and Revenues = -Dr and +Cr
                            * Net Income = Revenue - Expenses
                            * Net Income will be added to equity on closing
                        }
                        object AccountsCategorization {
                            = Assets(+Dr, -Cr)
                            |_ Cash
                            |_ Customer Receivable
                            ---
                            = Expenses(+Dr, -Cr))
                            ---
                            = Liabilities(-Dr, +Cr)
                            |_ MP Service Payable
                            |_ Tax Payable
                            |_ Vendor Payable
                            |_ Payment Service Payable
                            ---
                            = Equity(-Dr, +Cr)
                            |_ Net income
                            ---
                            = Revenues(-Dr, +Cr)
                            |_ Commission Revenue
                        }
                        node TrialBalance{
                            object TrialBalance{
                                =Assets
                                |= |= Debit(+) |= Credit(-) |
                                | Cash | $SC_Assets() |  |
                                | **Total** | **$$SC_Assets() ** |

                                \n
                                =Liabilities
                                |= |= Debit(-) |= Credit(+) | 
                                | Payment Service Payable | | $PSP.FeeValue |
                                | MP Service Payable |  | $MP.CommissionValue | 
                                | Tax Payable |  | $SCAYLE.TaxValue |
                                | Merchant Payable |  | $MERCHANT.SaleValue |
                                | **Total** |  | **$SC_Liabilities() ** |

                                \n
                                =Equity
                                |= |= Debit(-) |= Credit(+) | 
                                | Net Income |  | $SC_Equities() |
                                | **Total** |  | **$SC_Equities()** |

                            }
                        }
                    }
                }
                package "<color:white>AYMP Legal Entity" as AYMPLE #Black{
                    legend
                    Taking care of 
                    * Tax payable
                    * Collecting commissions
                    end legend
                    package "Data management framework - AYMP" #CadetBlue{
                        node JournalsDataEntity_AYMP
                    }
                }
                legend
                Taking care of 
                * SPAY-AYMP concolidation
                * Reporting 
                end legend
            }
        }
        package "DataIntegrator" #BurlyWood{
            cloud RecurringIntegrator
            frame "MasterData" {
                component [MasterDataImporterAPI]
            }
        }
        object Nav {
            <img:https://www.brightanalytics.eu/wp-content/uploads/Microsoft-Dynamics-NAV.png>
        }
        object SalesForce {
            <img:https://www.salesforce.com/content/dam/web/en_is/www/images/campaigns/sem/sales-cloud/sf-logo.png>
        }
        object SAP{
            <img:https://www.sap.com/dam/application/shared/logos/sap-logo-svg.svg/sap-logo-svg.svg>
        }
    }
}
together Links{
    together CustomerLinks{
        AlexTheCustomer -[bold]-> Checkout
        CustomerBA .[#Cyan,dotted,thickness=10].> settlment_file_portin
    }
    Checkout -[#Black,dashed,thickness=10]-> PaymentCoordinator: Starting point
    together ScayleAppLinkes{
        PaymentCoordinator -[#Black,dashed,thickness=10]> Klarna
        MonthlyBatchJob -d-> PayoutDistributor
        PayoutDistributor ..> EscrowBalanceManagerAPI
        EscrowBalanceManagerAPI .d.> ScayleFeeCollectorBA
        EscrowBalanceManagerAPI .> AdidasSalesCollectorBA
        settlment_file_portout -[#GreenYellow,dashed,thickness=10]u-> TransCollectorAPI: Settlment/\nTransaction files
        TransCollectorAPI -[#GreenYellow,dashed,thickness=10]d-> EntryPoint: A

        'hidden links
        Refrences -[hidden]d- TransCollectorAPI
        PayoutSettlments -[hidden]u- Refrences
        TransCollectorAPI -[hidden]d- PayoutSettlments
        ScayleAuditingControlCenter -[hidden]u- MerchantPayoutIssuer
    }
    together PSPLinks{
        Klarna -l-> CustomerBA
        Klarna --> EscrowBA
        Klarna -> KlarnaFeeCollectorBA
        KlarnaFeeCollectorBA .[#Cyan,dotted,thickness=10]d.> settlment_file_portin
        EscrowBalanceManagerAPI .> AYCommissionCollectorBA
    }
    together MiddlewareLinks{
        MatchFindingRules --> FileNamePatternMap
        MasterDataImporterAPI --> Database
        add_status -d-> UniversalStatusDB: +
        inquiryTransTracks -u-> UniversalStatusDB
        AuditingAPI -u-> inquiryTransTracks


        EntryPoint -d-> Validate
        ValidatorAPI -d-> Validated
        UploaderAPI -d-> Uploaded
        MasterDataDownloaderAPI -d-> Downloaded
        TransformerAPI -d-> Transformed
        ReconcilerAPI -d-> Reconciled
        AggregatorAPI -d-> Aggregated
        ResultGeneratorAPI -d-> Generated
        ResultSaverAPI -d-> Saved
        Saved -d-> D365FinOpsERP_Outbound_Storage

        Logger --> add_status
        AuditingAPI <-u-> ScayleAuditingControlCenter
        'hiddens
        EntryPoint -[hidden]- Validator
        Validator -[hidden]d- Uploader
        Uploader -[hidden]d- MasterDataDownloader
        MasterDataDownloader -[hidden]d- Transformer
        Transformer -[hidden]d- Reconciler
        Reconciler -[hidden]d- Aggregator
        Aggregator -[hidden]d- ResultGenerator
        ResultGenerator -[hidden]d- ResultSaver

    }
    D365FinOpsERP_Outbound_Storage -[#DodgerBlue,dashed,thickness=10]-> RecurringIntegrator: K
    together BanksLinks{
        EscrowBA .[#Cyan,dotted,thickness=10].> settlment_file_portin
        AYCommissionCollectorBA .[#Cyan,dotted,thickness=10].> settlment_file_portin
        ScayleFeeCollectorBA .[#Cyan,dotted,thickness=10].> settlment_file_portin
        AdidasSalesCollectorBA .[#Cyan,dotted,thickness=10].> settlment_file_portin
    }
    together ERPGangLinks {
        Parties -[bold]u-> MasterDataImporterAPI
        AYMPLE ..> Nav
        JournalsDataEntity --> JournalsDataEntity_AYMP
        JournalsDataEntity ..> Nav

        'hidden links
        Nav -[hidden]d- SalesForce        
        Nav -[hidden]d- SAP        
    }
    RecurringIntegrator -[#DodgerBlue,dashed,thickness=10]-> JournalsDataEntity: L
}
@enduml